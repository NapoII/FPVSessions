<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FPV Sessions</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    /* Full-page loading overlay */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.6);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity .3s ease, visibility .3s ease;
    }
    #loadingOverlay.hidden {
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    /* Liquid Glass (Glasmorphism) */
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0ea5e9 100%);
      color: #e2e8f0;
    }
    .glass {
      /* slightly subtler */
      background: rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    /* Top-right logout button */
    .top-logout {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 12000; /* ensure logout sits above footer */
    }
    .top-logout .btn {
      background: rgba(255,255,255,0.04);
      color: #e2e8f0;
      border: 1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      box-shadow: 0 6px 18px rgba(2,6,23,0.45);
    }
    /* Trading Card styling */
    .tcg-card {
      position: relative;
      overflow: hidden;
      border-radius: 18px;
      background: radial-gradient(1000px 400px at 10% 10%, rgba(255,255,255,0.12), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.25);
      box-shadow: 0 12px 30px rgba(2, 8, 23, 0.55), inset 0 0 0 1px rgba(255,255,255,0.06);
    }
    .tcg-card:before {
      content: "";
      position: absolute;
      top: -60%; left: -60%;
      width: 220%; height: 220%;
      background: conic-gradient(from 0deg, rgba(255,255,255,0.10), rgba(14,165,233,0.15), rgba(168,85,247,0.15), rgba(255,255,255,0.10));
      filter: blur(24px);
      transform: rotate(0deg);
      transition: transform .8s ease;
      pointer-events: none;
    }
    .tcg-card:hover:before { transform: rotate(20deg); }
    .tcg-card:after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 18px;
      padding: 1px;
      background: linear-gradient(135deg, rgba(14,165,233,0.6), rgba(168,85,247,0.6));
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      pointer-events: none; opacity: .28;
    }
    .tcg-header {
      position: absolute;
      top: 8px; left: 8px;
      background: rgba(0,0,0,0.35);
      color: #e2e8f0;
      padding: .25rem .5rem;
      font-size: .75rem;
      border-radius: .5rem;
      border: 1px solid rgba(255,255,255,0.18);
      z-index: 3;
    }
    .calendar-mini { padding:.75rem; margin-bottom:1rem; max-width: 560px; margin-left:auto; margin-right:auto; }
    .calendar-mini .month { font-weight:600; font-size:.95rem; }
    .calendar-mini .days { display:grid; grid-template-columns: repeat(7, 1fr); gap:.25rem; margin-top:.25rem; }
    .calendar-mini .weekday-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:.25rem; margin-top:.5rem; font-size:.75rem; text-transform:uppercase; opacity:.8; }
    .calendar-mini .day { font-size:.8rem; text-align:center; padding:.35rem .25rem; border-radius:.5rem; line-height:1; }
    .calendar-mini .has-sessions { background: rgba(14,165,233,.22); color:#e2e8f0; cursor:pointer; border:1px solid rgba(14,165,233,.35); }
    .calendar-mini .day.today { outline: 2px solid rgba(255,255,255,.5); }
    .session-card { transition: box-shadow .2s; }
    .session-thumb { height: 180px; object-fit: cover; width: 100%; background: #0b1220; border-top-left-radius: 16px; border-top-right-radius: 16px; }
    .thumb-video { pointer-events: none; }
    .session-title {
      font-size: 1.1rem;
      font-weight: 600;
      text-align: center;
      font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      letter-spacing: 0.5px;
    }
    .session-meta {
      font-size: .9rem;
      color: #cbd5e1;
      text-align: center;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      line-height: 1.4;
    }
    .session-card {
      min-width: 280px;
      max-width: 320px;
      margin: 0 auto;
      transition: box-shadow .2s;
    }

    /* Session Grid Layout - gleichmäßige Verteilung mit Mindestbreite */
    .session-item {
      display: flex;
      margin-bottom: 1.5rem;
    }

    /* Responsive Grid mit gleichmäßigen Abständen */
    @media (min-width: 768px) {
      .session-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        max-width: 100%;
      }
      .session-item {
        margin-bottom: 0;
      }
    }

    @media (min-width: 1200px) {
      .session-grid {
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 2rem;
      }
    }
    .card-body {
      text-align: center;
      padding: 1rem;
    }
    .session-card .badge {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Main page logo styling (use drone image, hover lift) */
    .main-logo {
      display: block;
      margin: 0 auto 0.8rem auto;
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      /* ensure no glow or drop-shadow */
      filter: none !important;
      box-shadow: none !important;
      transition: transform 260ms cubic-bezier(.2,.8,.2,1);
      animation: logoFloat 6s ease-in-out infinite;
      backface-visibility: hidden;
      transform-style: preserve-3d;
    }

    .main-logo:hover {
      transform: translateY(-8px) scale(1.06) rotateY(8deg);
      /* explicitly disable any hover glow */
      filter: none !important;
      box-shadow: none !important;
    }

    @keyframes mainLogoGlow {
      0%, 100% { filter: drop-shadow(0 0 25px rgba(14, 165, 233, 0.4)); }
      50% { filter: drop-shadow(0 0 40px rgba(14, 165, 233, 0.6)); }
    }
    @keyframes logoFloat { 0% { transform: translateY(0px); } 50% { transform: translateY(-4px); } 100% { transform: translateY(0px); } }
    /* Strong but very smooth left-right sway for drone on wrapper (no transform conflicts) */
    @keyframes logoSway {
      0% { transform: translate3d(-10px, 0, -6px) rotateZ(-1deg); }
      25% { transform: translate3d(-4px, -2px, -3px) rotateZ(-0.5deg); }
      50% { transform: translate3d(10px, 2px, 6px) rotateZ(1deg); }
      75% { transform: translate3d(6px, -1px, 3px) rotateZ(0.4deg); }
      100% { transform: translate3d(-10px, 0, -6px) rotateZ(-1deg); }
    }
    /* subtle vertical/orientation motion to make the drone 'tilt' and move in Z */
    @keyframes logo3DVert {
      0%   { transform: translate3d(0,0,0) rotateX(36deg) rotateY(8deg); }
      30%  { transform: translate3d(0,-4px,6px) rotateX(42deg) rotateY(6deg); }
      55%  { transform: translate3d(0,6px,12px) rotateX(32deg) rotateY(10deg); }
      80%  { transform: translate3d(0,-2px,4px) rotateX(38deg) rotateY(5deg); }
      100% { transform: translate3d(0,0,0) rotateX(36deg) rotateY(8deg); }
    }
    /* 3D wrapper for flattened drone look */
    /* Compact logo wrapper: tuck under calendar to save header space */
    .logo-3d-wrap {
      display: inline-block;
      perspective: 1200px;
      width: 110px; /* smaller footprint */
      height: 110px;
      padding: 8px; /* less breathing room */
      overflow: visible; /* allow animated parts to be visible */
      z-index: 800; /* sit under the calendar by default */
  margin-top: -40px; /* pull upward so it visually tucks under the calendar (closer to calendar) */
      /* combine horizontal sway with slower vertical 3D tilt to simulate orientation */
      animation: logoSway 14s cubic-bezier(.22,.8,.19,1) infinite, logo3DVert 10s ease-in-out infinite;
      will-change: transform;
      transform-style: preserve-3d;
      transition: transform 260ms ease, z-index 120ms ease;
    }

    /* ensure calendar sits above the logo by default */
    .calendar-mini { position: relative; z-index: 1000; }

    /* on hover, lift the logo slightly above the calendar */
    .logo-3d-wrap:hover {
      transform: translateY(-8px) scale(1.03);
      z-index: 1100; /* rise above calendar while hovering */
      pointer-events: auto;
    }
    /* larger glow behind the drone logo (bigger than image bounds) */
    .logo-3d-wrap {
      position: relative;
    }
    .logo-3d-wrap::before {
      /* disabled glow */
      display: none;
    }
    /* mask layer sits above the glow but behind the image to hide glow through transparency */
    .logo-3d-wrap::after {
      /* keep no extra mask, ensure transparent */
      content: '';
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      width: 120%;
      height: 120%;
      pointer-events: none;
      border-radius: 12px;
      background: transparent;
      filter: none;
      z-index: 1;
    }
    .logo-3d-wrap .main-logo { z-index: 2; position: relative; }
    .logo-3d-wrap .main-logo {
      transform-origin: 50% 65%;
      /* stronger X tilt and slight Y rotation to emphasize 3D shape */
      transform: rotateX(50deg) rotateY(12deg) translateY(6px);
      will-change: transform;
      /* remove visual glow/shadow for a clean look */
      box-shadow: none !important;
      filter: none !important;
    }
    .logo-3d-wrap .main-logo:hover {
      transform: rotateX(36deg) rotateY(0deg) translateY(-8px) scale(1.1) rotateZ(0deg);
      box-shadow: none !important;
      filter: none !important;
    }
    /* Footer: left credit + right rights text */
    .site-footer {
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 10px;
      z-index: 11000;
      font-size: 0.85rem;
      color: rgba(226,232,240,0.95);
      pointer-events: none;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      align-items: center;
    }
    .site-footer .left, .site-footer .right { pointer-events: auto; }
    .site-footer a { color: #a8d8ff; text-decoration: none; }
    .site-footer a:hover { text-decoration: underline; }
    /* Stats layout helpers for consistent spacing */
    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: .75rem 1.2rem;
      justify-content: center;
      align-items: center;
    }
    .stats-item {
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      white-space: nowrap;
    }
    .stats-range { display:flex; justify-content:center; align-items:center; gap:.6rem; }
    /* Make the search input visually match the calendar (rounded corners, glass look) */
    .input-group.search-like {
      border-radius: 16px; /* match .glass / calendar-mini */
      overflow: hidden; /* ensure inner controls don't overflow rounded corners */
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 8px 24px rgba(2,6,23,0.25);
    }
    .input-group.search-like .form-control {
      border: none;
      background: transparent;
      color: inherit;
      box-shadow: none;
    }
    .input-group.search-like .input-group-text,
    .input-group.search-like .btn {
      border: none;
      background: transparent;
      box-shadow: none;
    }
    /* Unified button styles (based on top-logout button look) */
    .btn-unified {
      background: rgba(255,255,255,0.04);
      color: #e2e8f0;
      border: 1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      box-shadow: 0 6px 18px rgba(2,6,23,0.45);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .btn-unified:hover { transform: translateY(-2px); }
    /* Pastel variants */
  /* more vivid pastel palette (higher saturation, still soft) */
  .btn-pastel-primary { background: linear-gradient(135deg,#77d9ff,#33b8ff); color: #012834; border-color: rgba(0,110,170,0.18); }
  .btn-pastel-info { background: linear-gradient(135deg,#9fefff,#66ddff); color: #012834; border-color: rgba(0,105,160,0.18); }
  .btn-pastel-warn { background: linear-gradient(135deg,#ffd58a,#ffb84d); color: #4a3410; border-color: rgba(255,145,0,0.18); }
  .btn-pastel-danger { background: linear-gradient(135deg,#ff9bb0,#ff4f76); color: #4a0f19; border-color: rgba(220,38,38,0.18); }
    .btn-unified.btn-sm { padding: .25rem .5rem; font-size: .85rem; }
    /* Particle styles (copied from login) */
    .bg-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      overflow: hidden;
      pointer-events: none;
    }
    .bg-animation .particles {
      position: absolute;
      width: 2px;
      height: 2px;
      background: rgba(14, 165, 233, 0.4);
      animation: particle-float 8s linear both;
    }
    @keyframes particle-float {
      0% { transform: translateY(0) translateX(0); opacity: 0; }
      10% { opacity: 1; }
      70% { opacity: 1; }
      100% { transform: translateY(-120vh) translateX(40px); opacity: 0; }
    }
  </style>
</head>
<body>
  <script>
    // initialize particles similar to login page
    document.addEventListener('DOMContentLoaded', function(){
      function createParticles(){
        const container = document.querySelector('.bg-animation');
        if (!container) return;
        for (let i = 0; i < 40; i++){
          setTimeout(() => {
            const p = document.createElement('div');
            p.className = 'particles';
            // spread horizontally and vertically so they don't stack at the top
            p.style.left = Math.random() * 100 + 'vw';
            p.style.top = (8 + Math.random() * 72) + 'vh';
            p.style.opacity = '0';
            p.style.animationDelay = Math.random() * 8 + 's';
            p.style.animationDuration = (Math.random() * 3 + 8) + 's';
            p.style.animationFillMode = 'both';
            container.appendChild(p);
            setTimeout(() => { try{ p.remove(); }catch(e){} }, 11000);
          }, Math.random() * 2000);
        }
      }
      createParticles();
      setInterval(createParticles, 10000);
    });
  </script>
  <!-- Animated Background (particles) copied from login for consistent effect -->
  <div class="bg-animation"></div>
<div id="loadingOverlay" aria-live="polite" aria-busy="true" style="display: none !important; opacity: 0 !important; visibility: hidden !important;">
  <div class="text-center">
    <div class="spinner-border text-info" style="width:3rem;height:3rem" role="status">
      <span class="visually-hidden">Loading…</span>
    </div>
    <div class="mt-2 text-light small">Loading sessions…</div>
    <div class="mt-2">
      <div class="progress" style="width: 200px; height: 6px; margin: 0 auto;">
        <div id="progressBar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
      </div>
      <div id="progressText" class="text-light small mt-1">0%</div>
    </div>
  </div>
</div>
<!-- Top-right Logout Button -->
<div class="top-logout">
  {% if is_admin %}
  <a href="{{ url_for('admin_settings') }}" class="btn btn-sm me-1" title="Admin Settings">
    <i class="fa-solid fa-gear"></i>
  </a>
  {% endif %}
  {% if can_create_sessions %}
  <a href="{{ url_for('create_sessions_page') }}" class="btn btn-sm me-1" title="Create Sessions">
    <i class="fa-solid fa-plus"></i>
  </a>
  {% endif %}
  <button id="logoutTopBtn" class="btn btn-sm">
    <i class="fa-solid fa-sign-out-alt"></i>
  </button>
</div>
<div class="container py-4">
  <div class="text-center">
    <a href="https://github.com/NapoII/FPVSessions" target="_blank" rel="noopener noreferrer" style="display:inline-block; overflow: visible;">
      <span class="logo-3d-wrap">
        <img id="mainLogo" src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="main-logo">
      </span>
    </a>
  </div>
  <!-- Calendar with Navigation -->
  <div class="calendar-mini glass">
    <div class="d-flex justify-content-between align-items-center">
      <button id="prevMonth" class="btn btn-sm btn-outline-light"><i class="fa-solid fa-chevron-left"></i></button>
      <div class="month fs-5">{{ '%02d' % month }} / {{ year }}</div>
      <button id="nextMonth" class="btn btn-sm btn-outline-light"><i class="fa-solid fa-chevron-right"></i></button>
    </div>
    <div class="weekday-grid">
      <div class="text-center">Mon</div>
      <div class="text-center">Tue</div>
      <div class="text-center">Wed</div>
      <div class="text-center">Thu</div>
      <div class="text-center">Fri</div>
      <div class="text-center">Sat</div>
      <div class="text-center">Sun</div>
    </div>
    <div class="days mt-1">
      {% for week in weeks %}
        {% for d in week %}
          {% if d.date %}
            <div class="day {{ 'has-sessions' if d.has else '' }} {{ '' if d.in_month else 'opacity-25' }} {{ 'today' if d.is_today else '' }}" data-date="{{ d.date }}">{{ d.day }}</div>
          {% else %}
            <div class="day opacity-0">.</div>
          {% endif %}
        {% endfor %}
      {% endfor %}
    </div>
  </div>

  <!-- Stats bar under calendar -->
    <div class="calendar-mini glass py-2 px-3 mb-3">
      <div class="stats-row">
    <span class="stats-item" data-bs-toggle="tooltip" title="Sessions: {{ stats.sessions }}"><i class="fa-solid fa-layer-group"></i><span class="badge bg-secondary text-light ms-1">{{ stats.sessions }}</span></span>
    <span class="stats-item" data-bs-toggle="tooltip" title="Videos: {{ stats.videos }}"><i class="fa-solid fa-film"></i><span class="badge bg-secondary text-light ms-1">{{ stats.videos }}</span></span>
    <span class="stats-item" data-bs-toggle="tooltip" title="Total duration: {{ stats.total_duration_human }}"><i class="fa-solid fa-clock"></i><span class="badge bg-secondary text-light ms-1">{{ stats.total_duration_human }}</span></span>
    <span class="stats-item" data-bs-toggle="tooltip" title="Total size: {{ stats.total_size_human }}"><i class="fa-solid fa-hard-drive"></i><span class="badge bg-secondary text-light ms-1">{{ stats.total_size_human }}</span></span>
    <span class="stats-item" data-bs-toggle="tooltip" title="Unique tags: {{ stats.tags_unique }}"><i class="fa-solid fa-tags"></i><span class="badge bg-secondary text-light ms-1">{{ stats.tags_total }}</span></span>
      </div>
      {% if stats.oldest_video or stats.newest_video %}
        <div class="mt-2 stats-range">
    <i class="fa-solid fa-calendar-days me-1" data-bs-toggle="tooltip" title="{% if stats.oldest_video %}Oldest video: {{ stats.oldest_video }}{% endif %}{% if stats.newest_video %}{% if stats.oldest_video %} • {% endif %}Newest video: {{ stats.newest_video }}{% endif %}"></i>
    <span class="badge bg-secondary text-light ms-1">{% if stats.oldest_video %}from {{ stats.oldest_video }}{% endif %}{% if stats.newest_video %} to {{ stats.newest_video }}{% endif %}</span>
        </div>
      {% endif %}
    </div>
  <div class="d-flex justify-content-center mb-2">
  <div class="input-group search-like" style="max-width:560px; width:100%;">
      <span class="input-group-text bg-dark text-white border-secondary"><i class="fa-solid fa-magnifying-glass"></i></span>
      <input id="searchBox" type="text" class="form-control bg-dark text-white border-secondary" placeholder="Search by name or tags..." value="{{ q or '' }}">
      <button class="btn btn-outline-secondary" id="resetFilter" type="button">Reset</button>
    </div>
  </div>
  <div class="text-center text-muted small mb-2">Visible sessions: <span id="countVisible"></span> / {{ sessions|length }}</div>
  <div class="d-flex justify-content-center">
    <div id="cards" class="session-grid">
      {% for session in sessions %}
      <div class="session-item" data-date="{{ session.date }}" data-tags="{{ (session.tags | join(' ')) if session.tags else '' }}" data-name="{{ (session.name + ' ' + session.sub) }}">
          <div class="glass tcg-card session-card h-100 position-relative" data-href="/session/{{ session.name }}/{{ session.sub }}">
            <div class="tcg-header">Session</div>
            {% if session.preview_thumb %}
              <div class="position-relative thumb-video-wrapper">
                <img class="session-thumb thumb-img" src="/media/{{ session.preview_thumb }}" alt="Session Thumbnail" loading="lazy">
                <video class="session-thumb thumb-video position-absolute top-0 start-0 w-100 h-100" data-src="/media/{{ session.preview_video or (session.thumbnails[0]['video'] if session.thumbnails) }}" muted loop preload="none" style="display:none;z-index:2;"></video>
              </div>
            {% elif session.images %}
              <img class="session-thumb" src="/media/{{ session.images[0] }}" alt="Session Thumbnail" loading="lazy">
            {% else %}
              <div class="session-thumb d-flex align-items-center justify-content-center text-white bg-secondary">
                <i class="fa-solid fa-drone fa-3x"></i>
              </div>
            {% endif %}
            <div class="card-body">
              <div class="session-title">{{ session.name }}</div>
              <div class="session-meta">{{ session.times.weekday }} {{ session.times.human_date }} • {{ session.times.time_range }} {% if session.times.duration_min %}• {{ session.times.duration_min }} min{% endif %}</div>
              <div class="mt-2 d-flex flex-wrap gap-2 justify-content-center">
                <span class="badge bg-primary"><i class="fa-solid fa-film"></i> {{ session.video_count }}</span>
                <span class="badge bg-success"><i class="fa-solid fa-image"></i> {{ session.image_count }}</span>
                <span class="badge bg-secondary"><i class="fa-solid fa-file-lines"></i> {{ session.log_count }}</span>
                <span class="badge bg-warning text-dark"><i class="fa-solid fa-microchip"></i> {{ session.blackbox_count }}</span>
              </div>
              {% if session.tags %}
              <div class="mt-2 d-flex flex-wrap gap-1 justify-content-center">
                {% for t in session.tags %}
                  <span class="badge rounded-pill text-bg-info">#{{ t }}</span>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
// No more loading overlay - removed completely
document.addEventListener('DOMContentLoaded', function(){
  console.log('Page loaded - no overlay to hide');

  // Calendar clicks
  document.querySelectorAll('.calendar-mini .day').forEach(function(dayEl){
    dayEl.addEventListener('click', function(){
      const dateStr = dayEl.getAttribute('data-date');
      if (dateStr) filterByDate(dateStr);
    });
  });
  // Prev/Next month navigation
  function navMonth(delta){
    const url = new URL(window.location.href);
    const y = parseInt(url.searchParams.get('year') || '{{ year }}', 10);
    const m = parseInt(url.searchParams.get('month') || '{{ month }}', 10);
    let ny = y; let nm = m + delta;
    if (nm < 1){ nm = 12; ny = y - 1; }
    if (nm > 12){ nm = 1; ny = y + 1; }
    url.searchParams.set('year', String(ny));
    url.searchParams.set('month', String(nm));
    window.location.href = url.toString();
  }
  const prevBtn = document.getElementById('prevMonth');
  const nextBtn = document.getElementById('nextMonth');
  if (prevBtn) prevBtn.addEventListener('click', () => navMonth(-1));
  if (nextBtn) nextBtn.addEventListener('click', () => navMonth(1));
  const reset = document.getElementById('resetFilter');
  if (reset){
    reset.addEventListener('click', function(){
      const searchBox = document.getElementById('searchBox');
      if (searchBox){ searchBox.value = ''; }
      document.querySelectorAll('.session-item').forEach(el => el.style.display='');
      const url = new URL(window.location.href);
      url.searchParams.delete('q');
      window.history.replaceState({}, '', url);
      updateVisibleCount();
    });
  }
  updateVisibleCount();

  // Search box
  const searchBox = document.getElementById('searchBox');
  function applySearch(){
    const q = (searchBox.value || '').trim().toLowerCase();
    const items = document.querySelectorAll('.session-item');
    items.forEach(el => {
      if (!q){ el.style.display = ''; return; }
      const name = (el.getAttribute('data-name') || '').toLowerCase();
      const tags = (el.getAttribute('data-tags') || '').toLowerCase();
      el.style.display = (name.includes(q) || tags.includes(q)) ? '' : 'none';
    });
    updateVisibleCount();
    const url = new URL(window.location.href);
    if (q){ url.searchParams.set('q', q); } else { url.searchParams.delete('q'); }
    window.history.replaceState({}, '', url);
  }
  if (searchBox){
    searchBox.addEventListener('input', applySearch);
  }

  // Hover video preview
  document.querySelectorAll('.thumb-video-wrapper').forEach(function(wrapper) {
    const img = wrapper.querySelector('.thumb-img');
    const vid = wrapper.querySelector('.thumb-video');
    if (img && vid) {
      try { vid.setAttribute('tabindex','-1'); } catch(e){}
      wrapper.addEventListener('mouseenter', function() {
        img.style.display = 'none';
        if (!vid.getAttribute('src')){
          const src = vid.getAttribute('data-src');
          if (src) vid.setAttribute('src', src);
        }
        vid.style.display = 'block';
        vid.play();
      });
      wrapper.addEventListener('mouseleave', function() {
        vid.pause();
        vid.style.display = 'none';
        img.style.display = 'block';
      });
    }
  });

  // Simple card navigation - fix clicking bug
  document.querySelectorAll('.session-card[data-href]').forEach(function(card){
    card.style.cursor = 'pointer';
    card.addEventListener('click', function(e) {
      e.preventDefault();
      const href = card.getAttribute('data-href');
      if (href) {
        window.location.href = href;
      }
    });
  });
});

// Filtering and counters - moved outside DOMContentLoaded
function updateVisibleCount(){
  const items = document.querySelectorAll('.session-item');
  let visible = 0;
  items.forEach(el => { if (el.style.display !== 'none') visible++; });
  const elCount = document.getElementById('countVisible');
  if (elCount) elCount.textContent = String(visible);
}

function filterByDate(dateStr){
  const items = document.querySelectorAll('.session-item');
  items.forEach(el => {
    const d = el.getAttribute('data-date');
    el.style.display = (d === dateStr) ? '' : 'none';
  });
  updateVisibleCount();
}

// Play login confirmation sound if user just logged in
document.addEventListener('DOMContentLoaded', function(){
  try{
    const dataEl = document.getElementById('app-data');
    const just = dataEl && dataEl.getAttribute('data-just-logged-in') === 'true';
    if (just){
      const a = new Audio('{{ url_for("static", filename="login/login.wav") }}');
      a.volume = 0.7;
      a.play().catch(()=>{});
    }
  }catch(e){}
});
</script>
<!-- expose a small, safe data attribute so we don't inject Jinja into inline JS expressions -->
<div id="app-data" data-just-logged-in="{{ 'true' if just_logged_in else 'false' }}" style="display:none" aria-hidden="true"></div>
<!-- surface FPV base status to JS -->
<div id="fpv-base-status" data-exists="{{ 'true' if fpv_base_exists else 'false' }}" data-path="{{ fpv_base_path }}" style="display:none" aria-hidden="true"></div>
<!-- admin default password hint -->
<div id="admin-pw-hint" data-admin-default="{{ 'true' if admin_password_is_default else 'false' }}" data-admin-isadmin="{{ 'true' if is_admin else 'false' }}" style="display:none" aria-hidden="true"></div>

<!-- Admin password change modal (non-browser popup) -->
<style>
  /* Darker pastel red modal with stronger contrast */
  #adminPwModal .modal-content {
    background: linear-gradient(135deg, #ff9b9b 0%, #ff6b6b 100%);
    color: #ffffff;
    border: none;
    box-shadow: 0 18px 60px rgba(0,0,0,0.45);
    border-radius: 12px;
    overflow: hidden;
  }
  #adminPwModal .modal-header, #adminPwModal .modal-footer { border: none; }
  #adminPwModal .modal-title, #adminPwModal .modal-body, #adminPwModal .modal-footer { color: #ffffff; }
  /* Ensure close button is visible on light background */
  /* Ensure close button is visible against darker background */
  #adminPwModal .btn-close { filter: invert(1) brightness(3); }
  /* Make Change button orange and primary-like for contrast */
  #adminPwModal .btn-warning, #adminPwModal .btn-primary { background: #ff8c2b; border-color: #ff8c2b; color: #fff; }
  #adminPwModal .btn-outline-light { color: rgba(255,255,255,0.95); border-color: rgba(255,255,255,0.18); }
</style>
<div class="modal fade" id="adminPwModal" tabindex="-1" aria-labelledby="adminPwModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="adminPwModalLabel">Change default admin password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Your admin account is using the default password. For security, please change the admin password now in Admin Settings.
      </div>
      <div class="modal-footer">
        <button type="button" id="adminPwDontShow" class="btn btn-outline-light">Don't show again</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Dismiss</button>
        <button type="button" id="adminPwChangeBtn" class="btn btn-warning" style="background:#ff8c2b;border-color:#ff8c2b">Change now</button>
      </div>
    </div>
  </div>
</div>
<script>
  // Logout button handler (top-right)
  (function(){
    const btn = document.getElementById('logoutTopBtn');
    if (!btn) return;
    btn.addEventListener('click', function(){
      fetch('/logout', {method:'GET', credentials:'same-origin'})
        .finally(() => { window.location.href = '/login'; });
    });
  })();

  // expose console helpers as well
  (function(){
    function doLogout(){ fetch('/logout', {method:'GET', credentials:'same-origin'}).finally(()=>window.location.href='/login'); }
    window.logoutConsole = doLogout; window['/logout'] = doLogout; window.consoleCommand = function(cmd){ if (String(cmd)==='/logout'){ doLogout(); return true;} return false; };
  })();

// end additional logout handlers
  // safety: if a persistent overlay was left visible, hide it and ensure pointer events work
  document.addEventListener('DOMContentLoaded', function(){
    try{
      const lo = document.getElementById('loadingOverlay');
      if (lo){ lo.style.display = 'none'; lo.classList.add('hidden'); lo.style.pointerEvents = 'none'; }
      document.body.style.pointerEvents = 'auto';
      const sf = document.querySelector('.site-footer'); if (sf){ sf.style.pointerEvents = 'none'; sf.style.zIndex = '10000'; }
      const top = document.querySelector('.top-logout'); if (top){ top.style.zIndex = '12000'; }
    }catch(e){ console.warn('overlay cleanup failed', e); }
    try{
      const cfg = document.getElementById('admin-pw-hint');
      const isDefault = cfg && cfg.getAttribute('data-admin-default') === 'true';
      const isAdmin = cfg && cfg.getAttribute('data-admin-isadmin') === 'true';
      // only show if user is admin and flag set
      if (isDefault && isAdmin){
        setTimeout(()=>{
          const modalEl = document.getElementById('adminPwModal');
          try{
            const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);
            bsModal.show();
          }catch(e){
            // fallback to window confirm
            if (confirm('Your admin account is using the default password. Please change the admin password now. Press OK to open Admin Settings or Cancel to dismiss.')){
              window.location.href = '/admin/settings';
            }
          }
        }, 300);
        // wire the Change now button
        document.getElementById('adminPwChangeBtn').addEventListener('click', function(){ window.location.href = '/admin/settings'; });
        // wire Don't show again: set a session flag via API
        const dontBtn = document.getElementById('adminPwDontShow');
        if (dontBtn){
          dontBtn.addEventListener('click', async function(){
            try{
              const r = await fetch('/api/admin/suppress-default-pw', {method:'POST'});
              if (r.ok){
                // hide modal
                try{ bootstrap.Modal.getInstance(document.getElementById('adminPwModal')).hide(); }catch(e){}
              } else {
                alert('Failed to set preference');
              }
            }catch(e){ alert('Failed'); }
          });
        }
      }
    }catch(e){}
  });

  </script>

  <!-- Modal: Missing Sessions Folder (admin-only) -->
  <div class="modal fade" id="missingBaseModal" tabindex="-1" aria-labelledby="missingBaseLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background: linear-gradient(135deg,#ffd58a,#ffb84d); color:#1f2937; border:none;">
        <div class="modal-header">
          <h5 class="modal-title" id="missingBaseLabel">Sessions folder not found</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          The configured sessions folder does not exist:<br>
          <code id="missingBasePath"></code>
          <div class="mt-2">Please set a valid folder in Admin Settings.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Dismiss</button>
          <a class="btn btn-warning" href="/admin/settings">Open Admin Settings</a>
        </div>
      </div>
    </div>
  </div>
  <script>
    // Show missing sessions folder modal to admin users only
    document.addEventListener('DOMContentLoaded', function(){
      try{
        const st = document.getElementById('fpv-base-status');
        const exists = st && st.getAttribute('data-exists') === 'true';
        const path = st ? st.getAttribute('data-path') : '';
        const admin = document.getElementById('admin-pw-hint');
        const isAdmin = admin && admin.getAttribute('data-admin-isadmin') === 'true';
        if (!exists && isAdmin){
          const el = document.getElementById('missingBasePath');
          if (el) el.textContent = path || '(not set)';
          try{ bootstrap.Modal.getOrCreateInstance(document.getElementById('missingBaseModal')).show(); }
          catch(e){ if (confirm('Sessions folder missing. Open Admin Settings now?')) { window.location.href = '/admin/settings'; } }
        }
      }catch(e){ /* ignore */ }
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      try{
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el) });
      }catch(e){ console.warn('tooltips init failed', e); }
    });
  </script>
  <script>
    // Fetch a random drone image like the login uses and set as main logo
    (async function(){
      try{
        const res = await fetch('/api/drones');
        if (!res.ok) return;
        const j = await res.json();
        const arr = j.drones || [];
        if (!arr.length) return;
        const pick = arr[Math.floor(Math.random()*arr.length)];
        const el = document.getElementById('mainLogo');
        if (el && pick) {
          el.src = pick;
          // play a short "pip" sound when pointer enters the logo, with cooldown
          try{
            let last = 0;
            el.addEventListener('pointerenter', function(){
              const now = Date.now();
              if (now - last < 800) return; // 800ms cooldown
              last = now;
              try{ const a = new Audio('{{ url_for("static", filename="login/pip.wav") }}'); a.volume = 0.7; a.play().catch(()=>{}); }catch(e){}
            });
          }catch(e){}
        }
      }catch(e){ /* ignore */ }
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
