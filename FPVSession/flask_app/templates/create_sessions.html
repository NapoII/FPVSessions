<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Create Sessions</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
  /* Match admin_settings visual theme: cream text, glass cards, unified pastel buttons */
  body{ background: linear-gradient(135deg,#0f172a,#102033); color:#fff8ec; font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif; }
  .container{ max-width:1000px; margin:40px auto; }
  .card{ background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); border-radius:12px; color: #fff8ec !important; }
  .card h5, .card p, .card strong, .card code { color: #fff8ec !important; }
  .btn-unified {
    background: rgba(255,255,255,0.04);
    color: #e2e8f0;
    border: 1px solid rgba(255,255,255,0.06);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    box-shadow: 0 6px 18px rgba(2,6,23,0.45);
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .btn-unified:hover { transform: translateY(-2px); }
  .btn-pastel-primary { background: linear-gradient(135deg,#77d9ff,#33b8ff); color: #012834; border-color: rgba(0,110,170,0.18); }
  .btn-pastel-info { background: linear-gradient(135deg,#9fefff,#66ddff); color: #012834; border-color: rgba(0,105,160,0.18); }
  .btn-pastel-warn { background: linear-gradient(135deg,#ffd58a,#ffb84d); color: #4a3410; border-color: rgba(255,145,0,0.18); }
  .stat-icon { width: 38px; height: 38px; display:inline-flex; align-items:center; justify-content:center; border-radius:10px; background: rgba(255,255,255,0.04); margin-right: 8px; }
  .monos { font-family: Consolas, "Courier New", monospace; }
  .log-box {
    background: rgba(0,0,0,0.35);
    border:1px solid rgba(255,255,255,0.04);
    border-radius: 10px; color: #fff8ec; font-family: Consolas, monospace; padding: .5rem; height: 240px; overflow:auto; white-space: pre-wrap;
  }
  /* Input group styling similar to admin settings */
  .input-group.search-like { border-radius: 12px; overflow: hidden; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 8px 24px rgba(2,6,23,0.25); }
  .input-group.search-like .form-control { border: none; background: transparent; color: inherit; box-shadow: none; }
  .input-group.search-like .input-group-text, .input-group.search-like .btn { border: none; background: transparent; box-shadow: none; }
  .top-logout { position: fixed; top: 12px; right: 12px; z-index: 12000; }
  .top-logout .btn { background: rgba(255,255,255,0.04); color: #e2e8f0; border:1px solid rgba(255,255,255,0.06); box-shadow: 0 6px 18px rgba(2,6,23,0.45); }
  .stat-item .label { opacity: 0; }
  .stat-item:hover .label { opacity: 1 !important; }
  .stat-item .fw-semibold { font-size: 1.05rem; }
  </style>
</head>
<body>
  <div class="top-logout">
    <a href="/" class="btn btn-sm me-1" title="Back to main"><i class="fa-solid fa-house"></i></a>
    <button id="logoutTopBtn" class="btn btn-sm" title="Logout"><i class="fa-solid fa-right-from-bracket"></i></button>
  </div>
  <div class="container">
    <h2 class="mb-3">Create Sessions</h2>
    <p class="text-muted">Process input videos into FPV session folders.</p>

    <div class="card p-3 mb-3">
      <h5 class="mb-2">Input folder</h5>
      <form id="inputForm" class="row g-2 align-items-end">
        <div class="col-md-8">
          <label class="form-label">Path</label>
          <div class="input-group">
            <span class="input-group-text bg-dark text-white border-secondary"><i class="fa-solid fa-folder"></i></span>
            <input id="inputDir" class="form-control bg-dark text-white border-secondary" value="{{ sorter_input }}" placeholder="C:\\path\\to\\input" required>
          </div>
        </div>
        <div class="col-md-4">
          <button type="submit" class="btn btn-pastel-primary btn-unified"><i class="fa-solid fa-floppy-disk"></i> Save</button>
        </div>
      </form>
      <div id="inputMsg" class="small mt-1"></div>
      <div class="d-flex align-items-center gap-2 mt-2" style="flex-wrap:wrap;">
        <div style="font-size:0.85rem; color:#fff8ec; opacity:0.95;">Sessions Folder (FPV_BASE):</div>
        <div class="monos" style="background:rgba(255,255,255,0.03); padding:.28rem .5rem; border-radius:8px; border:1px solid rgba(255,255,255,0.04); color:#fff8ec;">{{ FPV_BASE }}</div>
        {% if is_admin %}
          <div class="ms-auto">
            <a href="{{ url_for('admin_settings') }}" class="btn btn-sm btn-pastel-info btn-unified" title="Open Admin Settings to change FPV_BASE">Open Admin Settings</a>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="card p-3 mb-3">
      <div class="d-flex flex-wrap align-items-center gap-3 justify-content-center" style="column-gap:2rem;">
          <div class="d-flex flex-column align-items-center stat-item" title="Files">
            <span class="stat-icon" title="Files"><i class="fa-solid fa-file"></i></span>
            <div id="statCount" class="fw-semibold mt-1">0</div>
            <div class="small label mt-1" style="opacity:0; transition:opacity .12s;">Files</div>
          </div>
          <div class="d-flex flex-column align-items-center stat-item" title="Total size">
            <span class="stat-icon" title="Total size"><i class="fa-solid fa-hard-drive"></i></span>
            <div id="statSize" class="fw-semibold mt-1">0 B</div>
            <div class="small label mt-1" style="opacity:0; transition:opacity .12s;">Total size</div>
          </div>
          <div class="d-flex flex-column align-items-center stat-item" title="Total length">
            <span class="stat-icon" title="Total length"><i class="fa-solid fa-clock"></i></span>
            <div id="statDur" class="fw-semibold mt-1">0s</div>
            <div class="small label mt-1" style="opacity:0; transition:opacity .12s;">Total length</div>
          </div>
          <button id="refreshStats" class="btn btn-unified ms-2" title="Refresh"><i class="fa-solid fa-rotate"></i></button>
        </div>
    </div>

    <div class="row g-3">
      <div class="col-md-6">
        <div class="card p-3 h-100">
          <div class="d-flex align-items-center mb-2">
            <i class="fa-solid fa-1 me-2"></i>
            <h5 class="m-0">Run 1. Auto Rename</h5>
            <span id="doneRename" class="ms-2" style="display:none" title="Finished"><i class="fa-solid fa-circle-check text-success"></i></span>
            <button id="runRename" class="btn btn-sm btn-pastel-info btn-unified ms-auto"><i class="fa-solid fa-play"></i> Run</button>
          </div>
          <div id="logRename" class="log-box" aria-live="polite"></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-3 h-100">
          <div class="d-flex align-items-center mb-2">
            <i class="fa-solid fa-2 me-2"></i>
            <h5 class="m-0">Run 2. Auto Session</h5>
            <span id="doneSession" class="ms-2" style="display:none" title="Finished"><i class="fa-solid fa-circle-check text-success"></i></span>
            <button id="runSession" class="btn btn-sm btn-pastel-info btn-unified ms-auto"><i class="fa-solid fa-play"></i> Run</button>
          </div>
          <div id="logSession" class="log-box" aria-live="polite"></div>
        </div>
      </div>
    </div>

    <div class="card p-3 mb-3">
      <h5>How this page works</h5>
      <p class="small text-muted">
        Use this page to prepare and import raw videos into session folders.
      </p>
      <ul class="small">
        <li><strong>Input folder</strong> — the folder you point to is scanned for raw video files. Press <em>Refresh</em> to re-calc file count, total size and total duration.</li>
        <li><strong>Run 1 — Auto Rename</strong> — renames files in the input folder to a canonical naming scheme, tries to remove exact duplicates and normalizes timestamps. Output (stdout) is shown in the log box.</li>
        <li><strong>Run 2 — Auto Session</strong> — groups renamed files into session folders under your configured <code>FPV_BASE</code>. It creates subfolders (e.g. <code>FPV_Camera</code>, <code>IMG</code>, <code>Blackbox</code>), generates thumbnails and saves session metadata.</li>
        <li><strong>Logs</strong> — both scripts stream their console output here. A green check mark appears when a script exits with code 0.</li>
        <li><strong>Permissions</strong> — only users with the <code>create_sessions</code> permission (or admin) can run the scripts or change the input folder.</li>
      </ul>
      <p class="small text-muted">If you are unsure, run <em>Auto Rename</em> first and inspect the log before running <em>Auto Session</em>.</p>
    </div>
  </div>

  <script>
    // logout
    document.getElementById('logoutTopBtn')?.addEventListener('click', function(){ fetch('/logout').finally(()=>location.href='/login'); });

    // save input folder
    document.getElementById('inputForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const val = document.getElementById('inputDir').value.trim();
      const msg = document.getElementById('inputMsg');
      msg.textContent = 'Saving...';
      const r = await fetch('/api/sorter/config', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ input_dir: val }) });
      const j = await r.json().catch(()=>({}));
      if (r.ok){ msg.textContent = 'Saved'; refresh(); } else { msg.textContent = 'Error: ' + (j.error || 'failed'); }
    });

    async function refresh(){
      try{
        const r = await fetch('/api/sorter/stats');
        if (!r.ok) return;
        const j = await r.json();
        document.getElementById('statCount').textContent = j.count ?? 0;
        document.getElementById('statSize').textContent = j.total_size_human ?? '0 B';
        document.getElementById('statDur').textContent = j.total_duration_human ?? '0s';
      }catch(e){}
    }
    document.getElementById('refreshStats').addEventListener('click', refresh);
    refresh();

    let renameJob = null;
    let sessionJob = null;
    let pollTimers = {};

    function appendLog(el, lines){
      const box = document.getElementById(el);
      if (!box) return;
      box.textContent = lines.join('\n');
      box.scrollTop = box.scrollHeight;
    }

    async function poll(jobId, elLog, elDone){
      if (pollTimers[jobId]) clearInterval(pollTimers[jobId]);
      async function once(){
        const r = await fetch('/api/sorter/log/'+encodeURIComponent(jobId));
        if (!r.ok) return;
        const j = await r.json();
        appendLog(elLog, j.lines || []);
        if (!j.status?.running){
          clearInterval(pollTimers[jobId]);
          pollTimers[jobId] = null;
          if ((j.status?.exit_code ?? -1) === 0){ document.getElementById(elDone).style.display = ''; }
        }
      }
      await once();
      pollTimers[jobId] = setInterval(once, 800);
    }

    async function run(script){
      const r = await fetch('/api/sorter/run', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ script }) });
      const j = await r.json().catch(()=>({}));
      if (!r.ok){ alert('Failed: '+(j.error||'unknown')); return null; }
      return j.job_id;
    }

    document.getElementById('runRename').addEventListener('click', async function(){
      const id = await run('rename');
      if (id){ document.getElementById('logRename').textContent=''; document.getElementById('doneRename').style.display='none'; poll(id, 'logRename', 'doneRename'); }
    });
    document.getElementById('runSession').addEventListener('click', async function(){
      const id = await run('session');
      if (id){ document.getElementById('logSession').textContent=''; document.getElementById('doneSession').style.display='none'; poll(id, 'logSession', 'doneSession'); }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
